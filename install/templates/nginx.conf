user www;

#worker_processes  2;
pid        /var/run/nginx.pid;
error_log  /var/log/httpd.err error;

events {
    worker_connections  128;
}

http {
    include         mime.types;
    default_type    application/octet-stream;
    access_log      /var/log/httpd.log combined;

    # Not in OpenBSD? sendfile       on;
    # Not in OpenBSD? tcp_nopush     on;
    # use default 75s? keepalive_timeout  5;
    server_name_in_redirect off;

    client_max_body_size    30M;
    client_body_buffer_size 512k;

    gzip            on;
    gzip_vary       on;
    #gzip_comp_level 9;
    #gzip_min_length 0;
    gzip_proxied    any;
    gzip_disable    "msies";
    gzip_types      text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;
    #gzip_buffers    16 8k;


    #https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    #ssl_ciphers ECDH+AESGCM:ECDH+CHACHA20:ECDH+AES256:ECDH+AES128:!aNULL:!SHA1:!AESCCM;
    #ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256;
    # join in ssl_ciphers
    ssl_ciphers TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:ECDH+AESGCM:ECDH+CHACHA20:ECDH+AES256:ECDH+AES128:!aNULL:!SHA1:!AESCCM;

    ssl_certificate      /etc/ssl/server.crt;
    ssl_certificate_key  /etc/ssl/private/server.key;

    ssl_session_cache shared:SSL:1m;


    # upstream admin_mongrels {
    #    server 127.0.0.1:4213;
    # }
    # upstream account_mongrels {
    #     server 127.0.0.1:4214;
    # }

    # ADMIN SERVER
    # server {
    #     listen 4200 ssl
    #     root   /var/mailserv/admin/public;

    #     location ~* \.(ico|css|js|gif|jpe?g|png) {
    #         access_log off;
    #         expires 7d;
    #         break;
    #     }

    #     location / {
    #         proxy_redirect   off;
    #         proxy_set_header Host              $host:4200;
    #         proxy_set_header X-Real-IP         $remote_addr;
    #         proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    #         proxy_set_header X_Forwarded_Proto $scheme;

    #         if (!-f $request_filename.html) {
    #             proxy_pass  http://admin_mongrels;
    #         }
    #     }
    # }

    # Only HTTPS
    server {
        listen 80 default_server;
        server_name _;
        location / {
            return 301 https://$host$request_uri;
        }

        #letsencrypt
        location /.well-known/acme-challenge/ {
            alias       /var/www/acme/;
            try_files   $uri =404;
        }
    }
  
    # HTTPS
    server {
        listen  443 ssl;
        root    /var/www/webmail/webmail;
        index   index.php index.html index.htm;

        #php-fpm status
        location ^~ /fpm-status {
            #allow           1.2.3.4;
            deny            all;
            include         fastcgi_params;
            fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_pass    unix:/var/www/run/php-fpm.sock;
        }

        #phpMyAdmin
        location ^~ /phpMyAdmin/ {
            alias       /var/www/phpMyAdmin/;
            try_files   $uri =404;

            location ~ \.php$ {
                try_files       $uri =404;
                fastcgi_index   index.php;
                include         fastcgi_params;
                #fastcgi_param   SCRIPT_FILENAME  /phpMyAdmin/$fastcgi_script_name;
                fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_pass    unix:/var/www/run/php-fpm.sock;
            }
        }

        #See https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-dont-trust-the-tutorials-check-your-configuration/
        # pass the PHP scripts to FastCGI server listening on unix socket
        location ~ \.php$ {
            try_files       $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_index   index.php;
            include         fastcgi_params;
            #fastcgi_param   HTTPS on;
            #php-fpm is chroot /var/www
            #fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param   SCRIPT_FILENAME  /webmail/webmail/$fastcgi_script_name;
            fastcgi_pass    unix:/var/www/run/php-fpm.sock;
        }

        location ~* \.(ico|css|js|gif|jpe?g|png) {
            access_log off;
            expires 7d;
            break;
        }

        #ACCOUNT PAGES
        # location ^~ /account/stylesheets {
        #     alias /var/mailserv/account/public/stylesheets;
        # }

        # location ^~ /account/javascripts {
        #     alias /var/mailserv/account/public/javascripts;
        # }

        # location ^~ /account/images {
        #     alias /var/mailserv/account/public/images;
        # }

        # location /account {
        #     proxy_redirect    off;
        #     proxy_set_header  Host             $host;
        #     proxy_set_header  X-Real-IP        $remote_addr;
        #     proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
        #     proxy_set_header  Port             $proxy_port;

        #     if (!-f $request_filename.html) {
        #         proxy_pass  http://account_mongrels;
        #     }
        # }

    }

}
